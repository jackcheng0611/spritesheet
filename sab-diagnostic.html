<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SharedArrayBuffer 診斷工具</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin: 8px 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .fix-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 8px 4px;
        }
        .fix-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            overflow-x: auto;
            margin: 12px 0;
        }
        .instruction {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        h1, h2 {
            color: #2d3748;
        }
        .icon {
            font-size: 1.2em;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>🛡️ SharedArrayBuffer 診斷工具</h1>
        <p>這個工具幫助您診斷和修復 SharedArrayBuffer 不可用的問題，確保 FFmpeg.wasm 正常運作。</p>
    </div>

    <div class="card">
        <h2>📊 目前狀態檢查</h2>
        <div id="status-container">
            <div>
                <span class="icon">🌐</span>
                <strong>SharedArrayBuffer:</strong>
                <span id="sab-status" class="status">檢查中...</span>
            </div>
            <div>
                <span class="icon">⚙️</span>
                <strong>WebAssembly:</strong>
                <span id="wasm-status" class="status">檢查中...</span>
            </div>
            <div>
                <span class="icon">🔒</span>
                <strong>安全上下文:</strong>
                <span id="secure-status" class="status">檢查中...</span>
            </div>
            <div>
                <span class="icon">📡</span>
                <strong>HTTP 標頭:</strong>
                <span id="headers-status" class="status">檢查中...</span>
            </div>
        </div>
    </div>

    <div class="card" id="problem-card" style="display: none;">
        <h2>⚠️ 發現問題</h2>
        <div id="problem-description"></div>
        
        <h3>🔧 自動修復</h3>
        <button class="fix-button" onclick="restartServer()">重新啟動開發伺服器</button>
        <button class="fix-button" onclick="checkAgain()">重新檢查</button>
        
        <h3>📋 手動修復步驟</h3>
        <div class="instruction">
            <strong>步驟 1: 檢查 vite.config.js</strong>
            <p>確保您的配置檔案包含以下設定：</p>
            <div class="code-block">
export default defineConfig({
  server: {
    headers: {
      'Cross-Origin-Opener-Policy': 'same-origin',
      'Cross-Origin-Embedder-Policy': 'require-corp'
    }
  }
})
            </div>
        </div>

        <div class="instruction">
            <strong>步驟 2: 重新啟動開發伺服器</strong>
            <p>在終端機中執行：</p>
            <div class="code-block">
npm run dev
            </div>
        </div>

        <div class="instruction">
            <strong>步驟 3: 檢查瀏覽器支援</strong>
            <p>建議使用以下瀏覽器版本：</p>
            <ul>
                <li>Chrome 92+ </li>
                <li>Firefox 89+</li>
                <li>Safari 15.2+</li>
                <li>Edge 92+</li>
            </ul>
        </div>
    </div>

    <div class="card" id="solution-card" style="display: none;">
        <h2>✅ 一切正常！</h2>
        <p>您的環境已正確配置，SharedArrayBuffer 可用。FFmpeg.wasm 應該能正常載入。</p>
        <button class="fix-button" onclick="window.open('/', '_blank')">測試主應用程式</button>
    </div>

    <div class="card">
        <h2>🔍 詳細資訊</h2>
        <div id="detailed-info">
            <div><strong>User Agent:</strong> <span id="user-agent"></span></div>
            <div><strong>當前 URL:</strong> <span id="current-url"></span></div>
            <div><strong>協議:</strong> <span id="protocol"></span></div>
        </div>
    </div>

    <script>
        // 檢查基本資訊
        document.getElementById('user-agent').textContent = navigator.userAgent;
        document.getElementById('current-url').textContent = window.location.href;
        document.getElementById('protocol').textContent = window.location.protocol;

        function updateStatus(elementId, text, type) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = `status ${type}`;
        }

        function showCard(cardId) {
            document.getElementById('problem-card').style.display = 'none';
            document.getElementById('solution-card').style.display = 'none';
            if (cardId) {
                document.getElementById(cardId).style.display = 'block';
            }
        }

        async function checkEnvironment() {
            let hasProblems = false;
            let problemDescription = '';

            // 檢查 SharedArrayBuffer
            if (typeof SharedArrayBuffer !== 'undefined') {
                updateStatus('sab-status', '✅ 可用', 'success');
            } else {
                updateStatus('sab-status', '❌ 不可用', 'error');
                hasProblems = true;
                problemDescription += '<p><strong>SharedArrayBuffer 不可用</strong> - 需要設定 COOP/COEP 標頭</p>';
            }

            // 檢查 WebAssembly
            if (typeof WebAssembly !== 'undefined') {
                updateStatus('wasm-status', '✅ 支援', 'success');
            } else {
                updateStatus('wasm-status', '❌ 不支援', 'error');
                hasProblems = true;
                problemDescription += '<p><strong>WebAssembly 不支援</strong> - 請更新瀏覽器</p>';
            }

            // 檢查安全上下文
            if (window.isSecureContext) {
                updateStatus('secure-status', '✅ 安全', 'success');
            } else {
                updateStatus('secure-status', '⚠️ 不安全', 'warning');
                problemDescription += '<p><strong>不是安全上下文</strong> - 建議使用 HTTPS</p>';
            }

            // 檢查 HTTP 標頭（通過嘗試創建 SharedArrayBuffer）
            try {
                if (typeof SharedArrayBuffer !== 'undefined') {
                    new SharedArrayBuffer(1);
                    updateStatus('headers-status', '✅ 正確設定', 'success');
                } else {
                    throw new Error('SharedArrayBuffer 不可用');
                }
            } catch (error) {
                updateStatus('headers-status', '❌ 缺少標頭', 'error');
                hasProblems = true;
                problemDescription += '<p><strong>HTTP 標頭設定錯誤</strong> - 檢查伺服器配置</p>';
            }

            // 顯示結果
            if (hasProblems) {
                document.getElementById('problem-description').innerHTML = problemDescription;
                showCard('problem-card');
            } else {
                showCard('solution-card');
            }
        }

        window.restartServer = function() {
            alert('請在終端機中停止當前伺服器 (Ctrl+C) 然後執行 "npm run dev" 重新啟動');
        };

        window.checkAgain = function() {
            showCard(null);
            setTimeout(() => {
                checkEnvironment();
            }, 1000);
        };

        // 自動檢查
        checkEnvironment();

        // 每 5 秒重新檢查一次
        setInterval(checkEnvironment, 5000);
    </script>
</body>
</html>
