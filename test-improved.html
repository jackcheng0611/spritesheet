<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFmpeg æ¸¬è©¦ - æ”¹é€²ç‰ˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .loading { 
            background-color: #fff3cd; 
            border-color: #ffc107;
            color: #856404;
        }
        .success { 
            background-color: #d4edda; 
            border-color: #28a745;
            color: #155724;
        }
        .error { 
            background-color: #f8d7da; 
            border-color: #dc3545;
            color: #721c24;
        }
        button {
            padding: 12px 24px;
            margin: 10px 5px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
            width: 0%;
        }
        .details {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¬ FFmpeg è¼‰å…¥æ¸¬è©¦ - æ”¹é€²ç‰ˆ</h1>
    
    <div id="status" class="status loading">
        æº–å‚™é–‹å§‹æ¸¬è©¦...
    </div>
    
    <div class="progress" id="progressContainer" style="display: none;">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <div>
        <button onclick="startTest()" id="testBtn">é–‹å§‹æ¸¬è©¦</button>
        <button onclick="testBasic()" id="basicBtn">åŸºç¤æ¸¬è©¦</button>
        <button onclick="clearLogs()" id="clearBtn">æ¸…é™¤æ—¥èªŒ</button>
    </div>
    
    <div id="details" class="details">
        <strong>ç€è¦½å™¨è³‡è¨Šï¼š</strong><br>
        User Agent: <span id="userAgent"></span><br>
        WebAssembly æ”¯æ´: <span id="wasmSupport"></span><br>
        SharedArrayBuffer æ”¯æ´: <span id="sabSupport"></span><br>
        è¨˜æ†¶é«”: <span id="memory"></span><br>
        <hr>
        <div id="logs"></div>
    </div>

    <script type="module">
        // æª¢æŸ¥åŸºæœ¬æ”¯æ´
        document.getElementById('userAgent').textContent = navigator.userAgent;
        document.getElementById('wasmSupport').textContent = typeof WebAssembly !== 'undefined' ? 'âœ… æ”¯æ´' : 'âŒ ä¸æ”¯æ´';
        document.getElementById('sabSupport').textContent = typeof SharedArrayBuffer !== 'undefined' ? 'âœ… æ”¯æ´' : 'âŒ ä¸æ”¯æ´';
        document.getElementById('memory').textContent = navigator.deviceMemory ? `${navigator.deviceMemory}GB` : 'æœªçŸ¥';

        let ffmpeg = null;
        let isLoaded = false;
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${message}`);
            
            const logsEl = document.getElementById('logs');
            logsEl.innerHTML = logs.slice(-20).join('<br>'); // åªé¡¯ç¤ºæœ€å¾Œ20æ¢
            logsEl.scrollTop = logsEl.scrollHeight;
            
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function updateStatus(message, type = 'loading') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            log(message, type);
        }

        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('progressContainer');
            
            if (percent > 0) {
                progressContainer.style.display = 'block';
                progressBar.style.width = percent + '%';
            } else {
                progressContainer.style.display = 'none';
            }
        }

        window.clearLogs = function() {
            logs = [];
            document.getElementById('logs').innerHTML = '';
        };

        window.testBasic = async function() {
            updateStatus('é€²è¡ŒåŸºç¤æ¸¬è©¦...', 'loading');
            
            try {
                // æ¸¬è©¦ç¶²è·¯é€£æ¥
                log('æ¸¬è©¦ç¶²è·¯é€£æ¥...');
                const testUrl = 'https://unpkg.com/@ffmpeg/core@0.12.6/package.json';
                const response = await fetch(testUrl);
                if (response.ok) {
                    log('âœ… ç¶²è·¯é€£æ¥æ­£å¸¸');
                } else {
                    log(`âŒ ç¶²è·¯é€£æ¥ç•°å¸¸: ${response.status}`);
                }

                // æ¸¬è©¦ç€è¦½å™¨åŠŸèƒ½
                log('æ¸¬è©¦ç€è¦½å™¨åŠŸèƒ½...');
                if (typeof WebAssembly === 'undefined') {
                    throw new Error('ç€è¦½å™¨ä¸æ”¯æ´ WebAssembly');
                }
                
                if (typeof SharedArrayBuffer === 'undefined') {
                    log('âš ï¸ è­¦å‘Š: SharedArrayBuffer ä¸å¯ç”¨ï¼Œå¯èƒ½éœ€è¦è¨­å®š COOP/COEP æ¨™é ­');
                }

                // æ¸¬è©¦è¨˜æ†¶é«”
                if (navigator.deviceMemory && navigator.deviceMemory < 2) {
                    log('âš ï¸ è­¦å‘Š: è£ç½®è¨˜æ†¶é«”å¯èƒ½ä¸è¶³ (<2GB)');
                }

                updateStatus('åŸºç¤æ¸¬è©¦å®Œæˆ', 'success');
                
            } catch (error) {
                updateStatus(`åŸºç¤æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        };

        window.startTest = async function() {
            if (isLoaded) {
                updateStatus('FFmpeg å·²ç¶“è¼‰å…¥å®Œæˆï¼', 'success');
                return;
            }

            try {
                updateStatus('é–‹å§‹è¼‰å…¥ FFmpeg...', 'loading');
                updateProgress(5);

                // å‹•æ…‹å°å…¥
                log('æ­£åœ¨å°å…¥ FFmpeg æ¨¡çµ„...');
                const { FFmpeg } = await import('@ffmpeg/ffmpeg');
                const { toBlobURL } = await import('@ffmpeg/util');
                updateProgress(10);

                log('æ­£åœ¨åˆå§‹åŒ– FFmpeg å¯¦ä¾‹...');
                ffmpeg = new FFmpeg();
                updateProgress(15);

                // è¨­å®šäº‹ä»¶ç›£è½
                ffmpeg.on('log', ({ message }) => {
                    log(`FFmpeg: ${message}`);
                });

                ffmpeg.on('progress', ({ progress }) => {
                    const percent = Math.round(progress * 100);
                    updateProgress(20 + percent * 0.6); // 20-80% ç¯„åœ
                    log(`è™•ç†é€²åº¦: ${percent}%`);
                });

                // å˜—è©¦å¤šå€‹ CDN
                const cdnList = [
                    'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd',
                    'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd',
                ];

                let success = false;
                
                for (let i = 0; i < cdnList.length && !success; i++) {
                    const baseURL = cdnList[i];
                    log(`å˜—è©¦ CDN ${i + 1}/${cdnList.length}: ${baseURL}`);
                    
                    try {
                        updateProgress(25 + i * 10);
                        
                        // é å…ˆæª¢æŸ¥æª”æ¡ˆ
                        log('æª¢æŸ¥æ ¸å¿ƒæª”æ¡ˆ...');
                        const coreResponse = await fetch(`${baseURL}/ffmpeg-core.js`);
                        if (!coreResponse.ok) {
                            throw new Error(`æ ¸å¿ƒæª”æ¡ˆä¸å¯ç”¨: ${coreResponse.status}`);
                        }
                        
                        log('æª¢æŸ¥ WASM æª”æ¡ˆ...');
                        const wasmResponse = await fetch(`${baseURL}/ffmpeg-core.wasm`);
                        if (!wasmResponse.ok) {
                            throw new Error(`WASM æª”æ¡ˆä¸å¯ç”¨: ${wasmResponse.status}`);
                        }

                        updateProgress(40 + i * 15);
                        
                        // è¼‰å…¥æª”æ¡ˆ
                        log('è¼‰å…¥æ ¸å¿ƒæª”æ¡ˆ...');
                        const coreURL = await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript');
                        
                        log('è¼‰å…¥ WASM æª”æ¡ˆ...');
                        const wasmURL = await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm');

                        updateProgress(70);
                        
                        // åˆå§‹åŒ– FFmpeg
                        log('åˆå§‹åŒ– FFmpeg...');
                        await ffmpeg.load({
                            coreURL,
                            wasmURL,
                        });

                        success = true;
                        log(`âœ… æˆåŠŸä½¿ç”¨ CDN: ${baseURL}`);
                        
                    } catch (error) {
                        log(`âŒ CDN ${i + 1} å¤±æ•—: ${error.message}`);
                        if (i === cdnList.length - 1) {
                            throw error;
                        }
                    }
                }

                if (success) {
                    isLoaded = true;
                    updateProgress(100);
                    updateStatus('FFmpeg è¼‰å…¥æˆåŠŸï¼ğŸ‰', 'success');
                    log('ğŸ‰ FFmpeg è¼‰å…¥å®Œæˆï¼Œå¯ä»¥é–‹å§‹è™•ç†å½±ç‰‡äº†ï¼');
                    
                    // éš±è—é€²åº¦æ¢
                    setTimeout(() => updateProgress(0), 2000);
                }

            } catch (error) {
                updateProgress(0);
                updateStatus(`FFmpeg è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
                log(`âŒ æœ€çµ‚éŒ¯èª¤: ${error.message}`);
                
                // æä¾›è¨ºæ–·å»ºè­°
                if (error.message.includes('SharedArrayBuffer')) {
                    log('ğŸ’¡ å»ºè­°: å˜—è©¦ä½¿ç”¨ Chrome æˆ– Firefox ç€è¦½å™¨');
                } else if (error.message.includes('fetch')) {
                    log('ğŸ’¡ å»ºè­°: æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–é˜²ç«ç‰†è¨­å®š');
                } else if (error.message.includes('timeout')) {
                    log('ğŸ’¡ å»ºè­°: ç¶²è·¯é€Ÿåº¦è¼ƒæ…¢ï¼Œè«‹é‡è©¦æˆ–æ›´æ›ç¶²è·¯');
                }
            }
        };

        // è‡ªå‹•é€²è¡ŒåŸºç¤æ¸¬è©¦
        window.testBasic();
    </script>
</body>
</html>
